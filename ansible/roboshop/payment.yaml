- name: Creating Payment Microservice
  hosts: payment
  user: ansible
  become: yes

  tasks:
    - name: Install Python-3.6
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: installed
      loop:
        - python36 
        - gcc 
        - python3-devel

    - name: Checking User "roboshop" state
      ansible.builtin.command: id roboshop
      register: id_state
      ignore_errors: yes

    - name: Printing User "roboshop" state
      ansible.builtin.debug:
        msg: "User 'roboshop' state {{ id_state }}"

    - name: Create user "roboshop"
      ansible.builtin.user:
        name: roboshop
      when: id_state.rc !=0

    - name: Checking "/app" directory state
      ansible.builtin.stat:
        path: /app
      register: app_dir

    - name: Printing "/app" directoy state
      ansible.builtin.debug:
        msg: "'/app' directory state {{ app_dir }}"

    - name: Creating the "/app" Directory
      ansible.builtin.file:
        path: /app
        state: directory
      when: app_dir.stat.exists == False

    - name: Downloading "payment.zip" content
      ansible.builtin.get_url:
        url: https://roboshop-builds.s3.amazonaws.com/payment.zip
        dest: /tmp/payment.zip

    - name: Unarchive
      ansible.builtin.unarchive:
        src: /tmp/payment.zip
        dest: /app
        remote_src: yes

    - name: Install Python dependencies
      ansible.builtin.command: pip3.6 install -r requirements.txt
      args:
        chdir: /app

    - name: Copying "payment.service"
      ansible.builtin.copy:
        src: config_files/payment.service
        dest: /etc/systemd/system/payment.service

    - name: Daemon Reload
      ansible.builtin.systemd:
        name: payment.service
        state: reloaded
        enabled: yes

    - name: Daemon Reload
      ansible.builtin.systemd:
        name: payment.service
        state: restarted
      tags:
        - restart
      

